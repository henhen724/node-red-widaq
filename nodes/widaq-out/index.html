<script type="text/javascript">
    RED.nodes.registerType('widaq-out', {
        category: 'network',
        color: '#ef9a9a',
        defaults: {
            server: { value: "", type: "widaq-broker", required: true },
            topic: { value: "", required: true },
            qos: { values: 0 },
            retain: { values: "false" },
            name: { value: "" },
            useType: { value: "false" },
            verify: { value: "false" }
        },
        icon: "icons/icon.svg",
        inputs: 1,
        outputs: 0,
        label: function () {
            return this.name || this.topic || "widaq-out";
        },
        oneditprepare: function () {
            this.editor = RED.editor.createEditor({
                id: 'node-input-typeDef-editor',
                mode: 'ace/mode/graphqlschema',
                value: this.typeDef ? this.typeDef : `# Do not change the type name\ntype ${this.topic ? this.topic : '"<TOPIC_NAME/>"'} {\n\t# Change this to what ever properties you want\n\ton: Boolean\n}`
            });
            const tabs = RED.tabs.create({
                id: "node-config-widaq-out-tabs",
                onchange: function (tab) {
                    $("#node-config-widaq-out-tabs-content").children().hide();
                    $("#" + tab.id).show();
                }
            });
            tabs.addTab({
                id: "widaq-out-tab-connection",
                label: "Connection"
            });
            tabs.addTab({
                id: "widaq-out-tab-typeDef",
                label: "Type Definition"
            });
        },
        oneditsave: function () {
            this.typeDef = this.editor.getValue();
            this.editor.destroy();
            delete this.editor;
        },
        oneditcancel: function () {
            this.editor.destroy();
            delete this.editor;
        }
    });
</script>

<script type="text/html" data-template-name="widaq-out">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <ul style="min-width: 600px; margin-bottom: 20px;" id="node-config-widaq-out-tabs"></ul>
    </div>
    <div id="node-config-widaq-out-tabs-content" style="min-height:150px;">
        <div id="widaq-out-tab-connection" style="display:none">
            <div class="form-row">
                <label for="node-input-server"><i class="fa fa-globe"></i> Server</label>
                <input type="text" id="node-input-server">
            </div>
            <div class="form-row">
                <label for="node-input-topic"><i class="fa fa-tasks"></i> Topic</label>
                <input type="text" id="node-input-topic" placeholder="Topic">
            </div>
            <div class="form-row">
                <label for="node-input-qos"><i class="fa fa-empire"></i> QoS</label>
                <select type="text" id="node-input-qos" style="width:125px !important">
                    <option value="0">0</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                </select>
                <label for="node-input-retain"><i class="fa fa-history"></i> Retain</label>
                <select type="text" id="node-input-retain" style="width:125px !important">
                    <option value="false">false</option>
                    <option value="true">true</option>
                </select>
            </div>
        </div>
        <div id="widaq-out-tab-typeDef" style="display:none">
            <div class="form-row">
                <label for="node-input-useType"><i class="fa fa-code"></i> Use Type</label>
                <select type="text" id="node-input-useType" style="width:125px !important">
                    <option value="false">false</option>
                    <option value="true">true</option>
                </select>
                <label for="node-input-verify"><i class="fa fa-filter"></i> Verify Input</label>
                <select type="text" id="node-input-verify" style="width:125px !important">
                    <option value="false">false</option>
                    <option value="true">true</option>
                </select>
            </div>
            <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-typeDef-editor">
            </div>
        </div>
    </div>
</script>

<script type="text/html" data-help-name="widaq-out">
    <p>Connects to an MQTT Broker managed by a Wi DAQ server, publish messages to the specified topic, shares the user generated type for output, and validates input as matching.</p>
    <h3>Input</h3>
    <dl class="message-properties">
        <dt>payload
            <span class="property-type">object|TopicType</span>
        </dt>
        <dd> the message to send to the MQTT server. If it is an object it is stringified as JSON, if it is a string it is published as is. </dd>
        <dt>topic
            <span class="property-type">string</span>
        </dt>
        <dd> the topic that the MQTT packet will be published to. </dd>
        <dt>qos
            <span class="property-type">0|1|2</span>
        </dt>
        <dd> 0, fire and forget - 1, at least once - 2, once and once only. Default 0</dd>
        <dt>retain
            <span class="property-type">boolean</span>
        </dt>
        <dd> set to true to retain the message on the broker. Default false. </dd>
    </dl>
    <h3>Details</h3>
    <p>The subscription topic can include MQTT wildcards, + for one level, # for multiple levels.</p>
    <p>This node requires a connection to a Wi DAQ broker to be configured. This is configured by clicking the pencil icon.</p>
    <p>Several Wi DAQ nodes (in or out) can share the same broker connection if required.</p>
</script>